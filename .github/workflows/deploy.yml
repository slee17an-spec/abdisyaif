name: Deploy API (Production)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e
            cd /var/www/api
            git pull origin main
            npm install --omit=dev
            pm2 reload ecosystem.config.cjs --env production

    - name: Send email on failure
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.SMTP_HOST }}
        server_port: ${{ secrets.SMTP_PORT }}
        username: ${{ secrets.SMTP_USER }}
        password: ${{ secrets.SMTP_PASS }}
        subject: "‚ùå DEPLOY FAILED ‚Äî AbdiSyAIF API"
        to: ${{ secrets.ALERT_EMAIL_TO }}
        from: "AbdiSyAIF CI <${{ secrets.SMTP_USER }}>"
        body: |
          üö® Deploy FAILED

          Repo   : ${{ github.repository }}
          Branch : ${{ github.ref_name }}
          Commit : ${{ github.sha }}
          Actor  : ${{ github.actor }}

          üîó Logs:
          ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
